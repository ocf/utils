#!/bin/bash -eu
if [[ "$(hostname)" != "tsunami" && "$(hostname)" != "dev-tsunami" ]]; then
    echo -e '\033[1;31mYou must run this command on tsunami.\033[0m'
    exit 1
fi

PASS=$(sudo -u mysql /opt/share/utils/makeservices/makemysql-real | tee /dev/tty | tail -n 1 | grep -Po '(?<=: )([0-9a-zA-Z]){24,}$')

# Check if wp is installed with wp-cli
# And change password if installed with easywp
# But change password only if installed with easywp is a wrong statement
if (wp core is-installed --quiet --path="$HOME/public_html" > /dev/null 2>&1) &&
        ([ $# -ne 1 ] || ( [ $# -eq 1 ] && [ ! "$1" = '--ignore-wp' ])); then
    wp config set DB_PASSWORD "$PASS" > /dev/null 2>&1
fi
# Added for backward compatibility - the last line will be
# extracted by "tail -n 1" and the mysterious "grep"
# will extract the password after the colon
# So that it simulate the same behaviour as the original makemysql
# which output the same thing as in makemysql-real
echo "Your MySQL database password is: $PASS"
