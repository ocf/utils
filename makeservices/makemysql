#!/bin/bash -eu
if [[ "$(hostname)" != "tsunami" && "$(hostname)" != "dev-tsunami" ]]; then
    echo -e '\033[1;31mYou must run this command on tsunami.\033[0m'
    exit 1
fi

IGNORE_WP=false
SILENT=false

# Parse arguments down below
while (( "$#" )); do
    case "$1" in
        -i|--ignore-wp)
            IGNORE_WP=true
            shift
            ;;
        -s|--silent)
            SILENT=true
            shift
            ;;
        -*|--*)
            # Output to stderr
            echo "Error: Unsupported flag $1" >&2
            exit 1
            ;;
    esac
done

# The correctness of this line relies on the fact that
# makemysql-real will output the new password ONLY on the 
# last line. The --silent will also make sure it only output the password...
PASS=$(sudo -u mysql /opt/share/utils/makeservices/makemysql-real --silent | tail -n 1)

if [ $? -ne 0 ]; then
    echo 'makemysql did not exit properly. This script will stop.'
    exit 1
fi

# Check if wp is installed with wp-cli
# And change password if installed with easywp
# But change password only if installed with easywp is a wrong statement
# Use --ignore-wp flag to skip this process
if $IGNORE_WP && ! wp core is-installed --quiet --path="$HOME/public_html" > /dev/null 2>&1 ; then
    if ! $SILENT; then
        echo "WordPress installation detected, changing WordPress mysql password for you."
    fi
    wp config set DB_PASSWORD "$PASS" > /dev/null 2>&1
fi

if $SILENT; then
    echo "$PASS"
else
    # Added for backward compatibility - the last line will be
    # extracted by "tail -n 1" and the mysterious "grep"
    # will extract the password after the colon in legacy codes
    # So that it simulate the same behaviour as the original makemysql
    # which output the same thing as in makemysql-real
    echo "Your MySQL database password is: $PASS"
fi
